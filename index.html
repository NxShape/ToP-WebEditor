<!DOCTYPE html>
<html lang="eu">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Taste of Power Database Editor   </title>
        <link rel="stylesheet" href="./style.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    </head>

    <body>
        <div class="container" id="main_container">
            <div class="header">
                <h3>Units editor</h3>
            </div>
            <div class="table-wrapper">
                <table class="table table-hover" id="table-users">
                    <thead>
                        <tr>
                            <th style="text-align: left">Nation</th>
                            <th style="text-align: center">Unit name</th>
                            <th style="text-align: center">Health</th>
                            <th style="text-align: center">Move speed</th>
                            <th style="text-align: center">Actions</th>
                        </tr>
                    </thead>
                </table>
                <div style="text-align: center">
                    <button id="btn-add" class="btn btn-primary">Add Unit</button>
                </div>
            </div>

            <!-- Add Modal -->
            <div class="add-modal modal-wrapper">
                <div class="modal" id="add_user_modal">
                    <div class="header">
                        <h3>Add New User</h3>
                    </div>
                    <form class="form-container" style="margin-bottom:10px">
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label font-weight-bold" style="text-align:right">Nation</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" id="nation" placeholder="Nation">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label font-weight-bold" style="text-align:right">Unit name</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" id="unitName" placeholder="Unit name">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label font-weight-bold" style="text-align:right">Health</label>
                            <div class="col-sm-7">
                                <input type="number" class="form-control" id="health" placeholder="Health">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label font-weight-bold" style="text-align:right">Move speed</label>
                            <div class="col-sm-7">
                                <input type="number" class="form-control" id="moveSpeed" placeholder="Move speed">
                            </div>
                        </div>
                    </form>
                    <div style="text-align: center; margin-bottom: 10px;">
                        <button id="btn-add-modal" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries

            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
                apiKey: "AIzaSyB3Pv2TwRzUVxxtUYIZgKAx_9BHblRftrY",
                authDomain: "white-terra-357508.firebaseapp.com",
                databaseURL: "https://white-terra-357508-default-rtdb.firebaseio.com",
                projectId: "white-terra-357508",
                storageBucket: "white-terra-357508.appspot.com",
                messagingSenderId: "940325706530",
                appId: "1:940325706530:web:ce195db80443a0bb9be37b",
                measurementId: "G-2P7LPTG74L"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);

            import { getDatabase, ref, child, get, set, push, remove, onChildAdded, onChildChanged, onChildRemoved, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js"

            const db = getDatabase();
            var num = 0;

            const modalWrapper = document.querySelector('.modal-wrapper');
            
            // modal add
            const addUnitModal = document.querySelector(".add-modal");
            const addUnitModalForm = document.querySelector('.add-modal .form-container');

            // modal edit
            const editModal = document.querySelector('.edit-modal');
            const editModalForm = document.querySelector('.edit-modal .form');

            const btnAdd = document.querySelector("#btn-add");
            const btnAddModal = document.querySelector("#btn-add-modal");

            const tableUsers = document.querySelector("#table-users");

            function AddItemToTable(id, nation, unitName, health, moveSpeed){
                const tr = `
                    <tr data-id='${id}'>
                    <td style="text-align: left; vertical-align: middle">${nation}</td>
                    <td style="text-align: center; vertical-align: middle">${unitName}</td>
                    <td style="text-align: center; vertical-align: middle">${health}</td>
                    <td style="text-align: center; vertical-align: middle">${moveSpeed}</td>
                    <td style="text-align: center; vertical-align: middle">
                        <button class="btn btn-outline-success" id="btn_edit">Edit</button>
                        <button class="btn btn-outline-danger" id="btn_delete">Delete</button>
                    </td>
                    </tr>`;
                tableUsers.insertAdjacentHTML('beforeend', tr);

                // Click edit user
                const btnEdit = document.querySelector(`[data-id='${id}'] .btn-outline-success`);

                // Click delete user
                const btnDelete = document.querySelector(`[data-id='${id}'] .btn-outline-danger`);
                btnDelete.addEventListener('click', ()=>{
                    remove(ref(db, "UnitsList/" + id + "/"));
                });
            }

            function AddAllItemsToTable(dataList){
                dataList.forEach(element => {
                    AddItemToTable(element.nation + '_' + element.unitName, element.nation, element.unitName, element.health, element.moveSpeed);
                });
            }

            window.onload = GetAllDataOnce;
            window.onclick = function(event) {
                if (event.target == addUnitModal){
                    addUnitModal.style.display = "none";
                }
            }

            function GetAllDataOnce(){                
                btnAdd.addEventListener('click', () => {
                    addUnitModal.style.display = "block";
                });

                const dbRef = ref(db);

                const commentsRef = ref(db, "UnitsList");
                onChildAdded(commentsRef, (data) => {
                    //addCommentElement(postElement, data.key, data.val().text, data.val().author);
                    console.log("Added: " + data.key + "; " + data.val().unitName + "; " + data.val().author);
                    AddItemToTable(data.key, data.val().nation, data.val().unitName, data.val().health, data.val().moveSpeed);
                });

                onChildChanged(commentsRef, (data) => {
                    //setCommentValues(postElement, data.key, data.val().text, data.val().author);
                    console.log("Changed: " + data);
                });

                onChildRemoved(commentsRef, (data) => {
                    //deleteComment(postElement, data.key);
                    console.log("Removed: " + data);
                    let tr = document.querySelector(`[data-id='${data.key}']`);
                    let tbody = tr.parentElement;
                    tableUsers.removeChild(tbody);
                }); 

                get(child(dbRef, "UnitsList"))
                .then((snapshot) => {
                    //var units = [];

                    //snapshot.forEach(unitData => {
                    //    units.push(unitData.val());
                    //});

                    //AddAllItemsToTable(units);                    
                    

                    // onValue(ref(db, "UnitsList"), (snapshot) => {
                    //         snapshot.forEach((childSnapshot) => {
                    //             console.log("OnValue snapshot: " + childSnapshot.key + "; " + childSnapshot.val().unitName + "; " + childSnapshot.val().author);

                    //             if(childSnapshot.type === 'added') {
                    //                 console.log("Added snapshot: " + childSnapshot.key + "; " + childSnapshot.val().unitName + "; " + childSnapshot.val().author);
                    //             }
                    //             if(childSnapshot.type === 'removed') {
                    //                 console.log("Removed snapshot: " + childSnapshot.key + "; " + childSnapshot.val().unitName + "; " + childSnapshot.val().author);
                    //             }
                    //             if(childSnapshot.type === 'modified') {
                    //                 console.log("Changed snapshot: " + childSnapshot.key + "; " + childSnapshot.val().unitName + "; " + childSnapshot.val().author);
                    //             }
                    //         });
                    //     }, {
                    //     onlyOnce: true
                    // });
                });

                btnAddModal.addEventListener('click', () => {
                    console.log("Submit: " + addUnitModalForm.unitName.value + "; " + addUnitModalForm.nation.value + "; " + addUnitModalForm.health.value);

                    const postListRef = ref(db, 'UnitsList');
                    const newPostRef = push(postListRef);
                    set(newPostRef, {
                        nation: addUnitModalForm.nation.value,
                        unitName: addUnitModalForm.unitName.value,
                        health: addUnitModalForm.health.value,
                        moveSpeed: addUnitModalForm.moveSpeed.value
                    })
                    .then(() => {
                        alert("data stored success");
                    })
                    .catch((error) => {
                        alert("unsuccessful, error" + error);
                    })

                    addUnitModal.style.display = "none";
                });
            }
        </script>
    </body>
</html>